<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ZenCareer - Career Discovery Journey</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}">
    <!-- Add Lottie player for JSON animations -->
    <script src="https://unpkg.com/@lottiefiles/lottie-player@latest/dist/lottie-player.js"></script>
</head>
<body>
    <div class="quiz-container">
        <div class="video-container">
            <video id="worldJourney" class="world-journey">
                <source src="https://zencareer.b-cdn.net/world_journey.mp4" type="video/mp4">
                Your browser does not support the video tag.
            </video>
            <div class="video-overlay">
                <h2 id="locationTitle">Mount Fuji, Japan</h2>
            </div>
        </div>
        
        <!-- Personality trait notification -->
        <div id="traitNotification" class="trait-notification">
            <div class="trait-icon">âœ¨</div>
            <div class="trait-message">
                <h3>New Personality Trait Discovered!</h3>
                <p id="traitText">Analytical Thinker</p>
            </div>
        </div>
        
        <div class="quiz-content">
            <div class="pet-container">
                <!-- Lottie animation instead of static image -->
                <div class="pet-animation-container">
                    <lottie-player
                        id="petAnimation"
                        src="https://zencareer.b-cdn.net/{{ pet }}.json"
                        background="transparent"
                        speed="1"
                        style="width: 180px; height: 180px;"
                        loop
                        autoplay>
                    </lottie-player>
                </div>
                <div class="question-bubble">
                    <p id="petThought">I'm excited to help you discover your ideal career path!</p>
                </div>
            </div>
            
            <div class="question-container">
                <h2 class="question-text" id="questionText"></h2>
                <div class="answers-container" id="answersContainer"></div>
                
                <div class="progress-container">
                    <div class="progress-bar">
                        <div class="progress" id="progressBar" style="width: 0%"></div>
                    </div>
                    <p class="location-indicator" id="locationIndicator">Question 1/40: Mount Fuji, Japan</p>
                </div>
            </div>
        </div>
    </div>
    
    <audio id="clickSound" src="https://zencareer.b-cdn.net/click.mp3" preload="auto"></audio>
    
    <script>
        // Quiz logic
        document.addEventListener('DOMContentLoaded', () => {
            const clickSound = document.getElementById('clickSound');
            const worldJourney = document.getElementById('worldJourney');
            const petThought = document.getElementById('petThought');
            const questionText = document.getElementById('questionText');
            const answersContainer = document.getElementById('answersContainer');
            const progressBar = document.getElementById('progressBar');
            const locationIndicator = document.getElementById('locationIndicator');
            const locationTitle = document.getElementById('locationTitle');
            const traitNotification = document.getElementById('traitNotification');
            const traitText = document.getElementById('traitText');
            
            // Video timestamps for pausing
            const timestamps = {{ timestamps|tojson }};
            
            // Locations corresponding to timestamps
            const locations = {{ locations|tojson }};
            
            // Personality traits to reveal
            const personalityTraits = {{ personality_traits|tojson }};
            
            let currentQuestionIndex = 0;
            let userAnswers = [];
            let questions = [];
            let videoIsPlaying = false;
            
            // Play click sound
            const playClickSound = () => {
                clickSound.currentTime = 0;
                clickSound.play().catch(err => console.log('Audio playback error:', err));
            };
            
            // Update progress
            const updateProgress = () => {
                const progress = ((currentQuestionIndex + 1) / timestamps.length) * 100;
                progressBar.style.width = `${progress}%`;
                locationIndicator.textContent = `Question ${currentQuestionIndex + 1}/${timestamps.length}: ${locations[currentQuestionIndex]}`;
                locationTitle.textContent = locations[currentQuestionIndex];
            };
            
            // Display current question
            const displayQuestion = () => {
                if (!questions[currentQuestionIndex]) {
                    console.error("Question not found for index:", currentQuestionIndex);
                    return;
                }
                
                const question = questions[currentQuestionIndex];
                
                // Update pet thought
                petThought.textContent = question.petThought || "What do you think about this?";
                
                // Display question
                questionText.textContent = question.question;
                
                // Clear previous answers
                answersContainer.innerHTML = '';
                
                // Add answer options
                question.answers.forEach((answer, index) => {
                    const answerElement = document.createElement('div');
                    answerElement.classList.add('answer-option');
                    answerElement.textContent = answer;
                    answerElement.addEventListener('click', () => selectAnswer(index));
                    answersContainer.appendChild(answerElement);
                });
                
                // Update progress and location
                updateProgress();
                
                // Check if we should show a trait notification (every 5 questions)
                if ((currentQuestionIndex > 0) && (currentQuestionIndex % 5 === 0)) {
                    // Show trait notification
                    const traitIndex = Math.floor(currentQuestionIndex / 5) % personalityTraits.length;
                    showTraitNotification(personalityTraits[traitIndex]);
                }
            };
            
            // Show personality trait notification
            const showTraitNotification = (trait) => {
                traitText.textContent = trait;
                traitNotification.classList.add('show');
                
                // Hide after 3 seconds
                setTimeout(() => {
                    traitNotification.classList.remove('show');
                }, 3000);
            };
            
            // Handle answer selection
            const selectAnswer = (answerIndex) => {
                playClickSound();
                
                // Save answer
                userAnswers.push({
                    questionIndex: currentQuestionIndex,
                    answerIndex: answerIndex
                });
                
                // Move to next question or finish
                if (currentQuestionIndex < timestamps.length - 1) {
                    currentQuestionIndex++;
                    
                    // Play video to next timestamp
                    playVideoToNextTimestamp();
                } else {
                    // Quiz completed, submit answers and redirect
                    submitAnswers();
                }
            };
            
            // Play video to next timestamp
            const playVideoToNextTimestamp = () => {
                if (currentQuestionIndex < timestamps.length) {
                    // If video is paused, play it
                    if (worldJourney.paused) {
                        worldJourney.play().catch(err => console.log('Video playback error:', err));
                        videoIsPlaying = true;
                    }
                }
            };
            
            // Submit answers to server
            const submitAnswers = () => {
                fetch("{{ url_for('submit_answers') }}", {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ answers: userAnswers }),
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success && data.redirect) {
                        window.location.href = data.redirect;
                    } else {
                        console.error('Error submitting answers:', data.error);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                });
            };
            
            // Video controls
            worldJourney.addEventListener('loadedmetadata', () => {
                // Start with the first location
                worldJourney.currentTime = timestamps[0];
                // Don't autoplay initially - just pause at Mount Fuji
                worldJourney.pause();
            });
            
            worldJourney.addEventListener('timeupdate', () => {
                // Check if we've reached the next timestamp
                if (videoIsPlaying && timestamps.includes(Math.floor(worldJourney.currentTime))) {
                    // Pause at timestamp and display new question
                    worldJourney.pause();
                    videoIsPlaying = false;
                    displayQuestion();
                }
            });
            
            // Force load Lottie animations properly
            const players = document.querySelectorAll('lottie-player');
            players.forEach(player => {
                const src = player.getAttribute('src');
                player.setAttribute('src', '');
                setTimeout(() => {
                    player.setAttribute('src', src);
                }, 100);
            });
            
            // Fetch questions from server
            fetch("{{ url_for('get_questions') }}")
                .then(response => response.json())
                .then(data => {
                    questions = data;
                    displayQuestion();
                })
                .catch(error => {
                    console.error('Error fetching questions:', error);
                });
        });
    </script>
</body>
</html>